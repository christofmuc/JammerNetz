name: ARM64 Server AMI Build

on: [push, pull_request]

jobs:
  build_and_package_arm64_ami:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gnome-devel
          sudo apt-get install -y g++ cmake libncurses-dev libglew-dev libncurses5-dev nlohmann-json3-dev
          sudo apt-get install -y libcurl4-openssl-dev pkg-config libasound2-dev libgtk-3-dev libglew-dev libjack-dev
          sudo apt-get install -y libasound2-dev libjack-jackd2-dev ladspa-sdk libcurl4-openssl-dev libfreetype-dev libfontconfig1-dev libx11-dev libxcomposite-dev libxcursor-dev libxext-dev libxinerama-dev libxrandr-dev libxrender-dev libwebkit2gtk-4.1-dev libglu1-mesa-dev mesa-common-dev

      - name: Build third_party/sentry-native for ARM64
        run: |
          cd third_party/sentry-native
          cmake -S . -B build_arm64 \
            -DSENTRY_BACKEND=crashpad \
            -DBUILD_JAMMERNETZ_CLIENT=OFF \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/staging_arm64/sentry \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_arm64 --target install
        working-directory: ${{ github.workspace }}

      - name: Build third_party/flatbuffers for ARM64
        run: |
          cd third_party/flatbuffers
          cmake -S . -B LinuxBuilds \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/staging_arm64 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build LinuxBuilds --target install
        working-directory: ${{ github.workspace }}

      - name: Build JammerNetz Server for ARM64
        run: |
          cmake -S . -B build_arm64 \
            -DBUILD_JAMMERNETZ_CLIENT=OFF \
            -DSENTRY_CRASH_REPORTING=ON \
            -DSENTRY_INSTALL_PATH=${{ github.workspace }}/staging_arm64/sentry \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/staging_arm64 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_arm64 --target JammerNetzServer
        working-directory: ${{ github.workspace }}

      - name: Prepare Files for AMI Packaging
        run: |
          mkdir -p ${{ github.workspace }}/packer_staging/usr/local/bin
          mkdir -p ${{ github.workspace }}/packer_staging/etc/systemd/system

          cp ${{ github.workspace }}/build_arm64/Server/JammerNetzServer ${{ github.workspace }}/packer_staging/usr/local/bin/

          cat > ${{ github.workspace }}/packer_staging/etc/systemd/system/JammerNetz.service << EOF
          [Unit]
          Description=JammerNetz Server
          After=network.target
          StartLimitIntervalSec=0

          [Service]
          Type=simple
          Restart=always
          RestartSec=1
          User=ubuntu
          ExecStart=/usr/local/bin/JammerNetzServer

          [Install]
          WantedBy=multi-user.target
          EOF

          cat > ${{ github.workspace }}/packer_staging/ami-setup.sh << 'EOF'
          #!/bin/bash
          set -ex # Exit on error and print commands
          echo 'Updating packages...'
          sudo apt-get update -y

          echo 'Installing runtime dependencies...'
          sudo apt-get install -y \
            libtbb12 \
            libcurl4 \
            libncurses6 \
            libssl3 \
            zlib1g

          echo 'Creating target directories if they do not exist...'
          sudo mkdir -p /usr/local/bin
          sudo mkdir -p /etc/systemd/system

          echo 'Copying JammerNetzServer binary from Packer staging area...'
          sudo cp /tmp/packer_files/usr/local/bin/JammerNetzServer /usr/local/bin/JammerNetzServer
          sudo chmod +x /usr/local/bin/JammerNetzServer

          echo 'Copying systemd service file from Packer staging area...'
          sudo cp /tmp/packer_files/etc/systemd/system/JammerNetz.service /etc/systemd/system/JammerNetz.service

          echo 'Reloading systemd and enabling service...'
          sudo systemctl daemon-reload
          sudo systemctl enable JammerNetz.service
          echo 'JammerNetz Server setup complete on AMI.'
          EOF

          chmod +x ${{ github.workspace }}/packer_staging/ami-setup.sh

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 # Adjust as needed

      - name: Install Packer
        run: |
          PACKER_VERSION="1.9.4" # Use more recent version
          wget -q "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
          sudo unzip "packer_${PACKER_VERSION}_linux_amd64.zip" -d /usr/local/bin/
          sudo chmod +x /usr/local/bin/packer
          packer version

      - name: Run Packer Build
        run: |
          packer init jammernetz-arm64.pkr.hcl
          packer build -color=false -on-error=abort jammernetz-arm64.pkr.hcl
        working-directory: ${{ github.workspace }}
