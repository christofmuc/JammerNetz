name: ARM64 Server AMI Build

on: [push, pull_request]

jobs:
  build_and_package_arm64_ami:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: arm64

      - name: Install Cross-Compilation Tools and ARM64 Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-aarch64-linux-gnu crossbuild-essential-arm64
          sudo apt-get install -y libncurses-dev:arm64 libcurl4-openssl-dev:arm64 libtbb-dev:arm64
          # As a fallback for libtbb-dev:arm64, we might need to build oneTBB from source later
          # For now, we try to install it via apt.

      - name: Create ARM64 CMake Toolchain File
        run: |
          echo "set(CMAKE_SYSTEM_NAME Linux)" > arm64-linux.toolchain.cmake
          echo "set(CMAKE_SYSTEM_PROCESSOR aarch64)" >> arm64-linux.toolchain.cmake
          echo "set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)" >> arm64-linux.toolchain.cmake
          echo "set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)" >> arm64-linux.toolchain.cmake
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> arm64-linux.toolchain.cmake
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> arm64-linux.toolchain.cmake
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> arm64-linux.toolchain.cmake
          echo "set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)" >> arm64-linux.toolchain.cmake
        working-directory: ${{ github.workspace }}

      - name: Build third_party/flatbuffers for ARM64
        run: |
          cd third_party/flatbuffers
          cmake -S . -B build_arm64 -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/arm64-linux.toolchain.cmake -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/staging_arm64
          cmake --build build_arm64 --target install
        working-directory: ${{ github.workspace }}/third_party/flatbuffers

      - name: Build third_party/sentry-native for ARM64
        run: |
          cd third_party/sentry-native
          cmake -S . -B build_arm64 -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/arm64-linux.toolchain.cmake -DSENTRY_BACKEND=crashpad -DBUILD_JAMMERNETZ_CLIENT=OFF -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/staging_arm64/sentry
          cmake --build build_arm64 --target install
        working-directory: ${{ github.workspace }}/third_party/sentry-native

      - name: Build JammerNetz Server for ARM64
        run: |
          cmake -S . -B build_arm64 \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/arm64-linux.toolchain.cmake \
            -DBUILD_JAMMERNETZ_CLIENT=OFF \
            -DSENTRY_CRASH_REPORTING=ON \
            -DSENTRY_INSTALL_PATH=${{ github.workspace }}/staging_arm64/sentry \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/staging_arm64
          cmake --build build_arm64 --target JammerNetzServer
        working-directory: ${{ github.workspace }}

      - name: Prepare Files for AMI Packaging
        run: |
          mkdir -p ${{ github.workspace }}/packer_staging/usr/local/bin
          mkdir -p ${{ github.workspace }}/packer_staging/etc/systemd/system

          cp ${{ github.workspace }}/build_arm64/Server/JammerNetzServer ${{ github.workspace }}/packer_staging/usr/local/bin/

          echo "[Unit]
          Description=JammerNetz Server
          After=network.target
          StartLimitIntervalSec=0
          [Service]
          Type=simple
          Restart=always
          RestartSec=1
          User=ubuntu
          ExecStart=/usr/local/bin/JammerNetzServer
          [Install]
          WantedBy=multi-user.target" > ${{ github.workspace }}/packer_staging/etc/systemd/system/JammerNetz.service

          echo "#!/bin/bash
          set -ex # Exit on error and print commands
          echo 'Updating packages...'
          sudo apt-get update -y
          echo 'Installing runtime dependencies...'
          # Ensure libtbb1 is the correct package name for ARM64 TBB runtime.
          # Other potential deps: libatomic1 if not covered by crossbuild-essential
          sudo apt-get install -y libtbb1 libcurl4 libncurses6

          echo 'Creating target directories if they do not exist...'
          sudo mkdir -p /usr/local/bin
          sudo mkdir -p /etc/systemd/system

          echo 'Copying JammerNetzServer binary from Packer staging area...'
          # This path assumes Packer's file provisioner copies to /tmp/packer_files/ on the instance
          sudo cp /tmp/packer_files/usr/local/bin/JammerNetzServer /usr/local/bin/JammerNetzServer
          sudo chmod +x /usr/local/bin/JammerNetzServer

          echo 'Copying systemd service file from Packer staging area...'
          sudo cp /tmp/packer_files/etc/systemd/system/JammerNetz.service /etc/systemd/system/JammerNetz.service

          echo 'Reloading systemd and enabling service...'
          sudo systemctl daemon-reload
          sudo systemctl enable JammerNetz.service
          echo 'JammerNetz Server setup complete on AMI.'
          # It's generally recommended not to start the service during AMI creation with Packer,
          # as Packer might not wait for it or handle its output correctly.
          # The service will start when an instance boots from the AMI.
          " > ${{ github.workspace }}/packer_staging/ami-setup.sh
          chmod +x ${{ github.workspace }}/packer_staging/ami-setup.sh
        # No working-directory needed here as paths are absolute with github.workspace

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1-node16 # Using a Node.js 16 compatible version
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          #aws-region: us-east-1 # Or use a variable/secret, e.g., ${{ secrets.AWS_REGION }}
                                # This should match the region in packer config or be passed as a var

      - name: Install Packer
        run: |
          PACKER_VERSION="1.8.5" # Specify a recent Packer version
          curl -OsSJL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
          unzip "packer_${PACKER_VERSION}_linux_amd64.zip" -d /usr/local/bin/
          packer version
        working-directory: /tmp # Download and unzip in /tmp

      - name: Run Packer Build
        #env:
          #PK_VAR_aws_region: eu-central-1 # Example if you want to override Packer vars
          #PK_VAR_source_ami_arm64: ami-xxxxxxxxxxxxxxxxx # If overriding source AMI
        run: |
          packer init jammernetz-arm64.pkr.hcl
          packer build -color=false -on-error=abort jammernetz-arm64.pkr.hcl
        working-directory: ${{ github.workspace }} # Ensure Packer runs where .pkr.hcl and packer_staging are
